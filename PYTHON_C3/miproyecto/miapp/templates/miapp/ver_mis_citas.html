{% extends 'miapp/base.html' %}

{% block title %}Mis Citas - SoulComfort{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary mb-3">
                    <i class="fas fa-calendar-alt me-2"></i>Mis Citas
                </h1>
                <p class="lead text-muted">
                    {% if user.userprofile.es_pasante %}
                    Citas agendadas con pacientes
                    {% else %}
                    Sesiones de terapia programadas
                    {% endif %}
                </p>
            </div>

            <!-- Lista de Citas -->
            <div class="card feature-card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        {% if user.userprofile.es_pasante %}Citas Agendadas{% else %}Mis Sesiones{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    {% if citas %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-primary">
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>
                                        {% if user.userprofile.es_pasante %}Paciente{% else %}Pasante{% endif %}
                                    </th>
                                    <th>Modalidad</th>
                                    <th>Estado</th>
                                    <th>Acción</th>
                                    <th>Detalles</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cita in citas %}
                                <tr>
                                    <td>
                                        <strong>{{ cita.fecha_cita|date:"d/m/Y" }}</strong><br>
                                        {{ cita.hora_inicio|time:"H:i" }} - {{ cita.hora_fin|time:"H:i" }}
                                        {% if cita.fecha_cita == hoy %}
                                        <span class="badge bg-warning text-dark ms-2">Hoy</span>
                                        {% elif cita.fecha_cita < hoy %}
                                        <span class="badge bg-secondary ms-2">Pasada</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.userprofile.es_pasante %}
                                        <strong>{{ cita.paciente.get_full_name|default:cita.paciente.username }}</strong>
                                        <br>
                                        <small class="text-muted">{{ cita.paciente.email }}</small>
                                        {% else %}
                                        <strong>{{ cita.pasante.get_full_name|default:cita.pasante.username }}</strong>
                                        <br>
                                        <small class="text-muted">Pasante</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if cita.modalidad == 'virtual' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-video me-1"></i>Virtual
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-building me-1"></i>Presencial
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if cita.estado == 'confirmada' %}
                                        <span class="badge bg-success">{{ cita.get_estado_display }}</span>
                                        {% elif cita.estado == 'pendiente' %}
                                        <span class="badge bg-warning text-dark">{{ cita.get_estado_display }}</span>
                                        {% elif cita.estado == 'completada' %}
                                        <span class="badge bg-info">{{ cita.get_estado_display }}</span>
                                        {% else %}
                                        <span class="badge bg-danger">{{ cita.get_estado_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if cita.modalidad == 'virtual' %}
                                            {% if cita.enlace_llamada and cita.puede_unirse %}
                                            <a href="{{ cita.enlace_llamada }}" 
                                               target="_blank" 
                                               class="btn btn-success btn-sm">
                                                <i class="fas fa-video me-1"></i>Unirse
                                            </a>
                                            {% elif cita.enlace_llamada %}
                                            <div class="d-flex flex-column">
                                                <small class="text-muted">Virtual</small>
                                                <small class="text-info">
                                                    {% if cita.fecha_cita > hoy %}
                                                    Habilitado 15 min antes
                                                    {% else %}
                                                    Expirada
                                                    {% endif %}
                                                </small>
                                            </div>
                                            {% else %}
                                            <span class="text-muted">Virtual</span>
                                            {% endif %}
                                        {% else %}
                                        <div class="d-flex flex-column">
                                            <span class="text-success">
                                                <i class="fas fa-map-marker-alt me-1"></i>Presencial
                                            </span>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#detalleCita{{ cita.id }}">
                                            <i class="fas fa-info-circle me-1"></i>Ver
                                        </button>

                                        <!-- Modal de Detalles -->
                                        <div class="modal fade" id="detalleCita{{ cita.id }}" tabindex="-1">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-primary text-white">
                                                        <h5 class="modal-title">
                                                            <i class="fas fa-calendar-check me-2"></i>
                                                            Detalles de la Cita
                                                        </h5>
                                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <h6 class="text-primary mb-3">Información General</h6>
                                                                <div class="mb-3">
                                                                    <strong>Fecha:</strong> {{ cita.fecha_cita|date:"d/m/Y" }}<br>
                                                                    <strong>Hora:</strong> {{ cita.hora_inicio|time:"H:i" }} - {{ cita.hora_fin|time:"H:i" }}<br>
                                                                    <strong>Estado:</strong> 
                                                                    {% if cita.estado == 'confirmada' %}
                                                                    <span class="badge bg-success">{{ cita.get_estado_display }}</span>
                                                                    {% elif cita.estado == 'pendiente' %}
                                                                    <span class="badge bg-warning text-dark">{{ cita.get_estado_display }}</span>
                                                                    {% elif cita.estado == 'completada' %}
                                                                    <span class="badge bg-info">{{ cita.get_estado_display }}</span>
                                                                    {% else %}
                                                                    <span class="badge bg-danger">{{ cita.get_estado_display }}</span>
                                                                    {% endif %}
                                                                    <br>
                                                                    <strong>Modalidad:</strong> 
                                                                    {% if cita.modalidad == 'virtual' %}
                                                                    <span class="badge bg-info">{{ cita.get_modalidad_display }}</span>
                                                                    {% else %}
                                                                    <span class="badge bg-success">{{ cita.get_modalidad_display }}</span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <h6 class="text-primary mb-3">
                                                                    {% if user.userprofile.es_pasante %}Paciente{% else %}Pasante{% endif %}
                                                                </h6>
                                                                <div class="mb-3">
                                                                    {% if user.userprofile.es_pasante %}
                                                                    <strong>Nombre:</strong> {{ cita.paciente.get_full_name|default:cita.paciente.username }}<br>
                                                                    <strong>Email:</strong> {{ cita.paciente.email }}<br>
                                                                    <strong>Teléfono:</strong> {{ cita.paciente.userprofile.telefono|default:"No registrado" }}
                                                                    {% else %}
                                                                    <strong>Nombre:</strong> {{ cita.pasante.get_full_name|default:cita.pasante.username }}<br>
                                                                    <strong>Email:</strong> {{ cita.pasante.email }}<br>
                                                                    <strong>Teléfono:</strong> {{ cita.pasante.userprofile.telefono|default:"No registrado" }}
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <hr>

                                                        <!-- Información de la Sesión -->
                                                        <h6 class="text-primary mb-3">Detalles de la Sesión</h6>
                                                        <div class="row">
                                                            <div class="col-12">
                                                                {% if cita.modalidad == 'virtual' %}
                                                                <div class="mb-3">
                                                                    <strong><i class="fas fa-video me-2 text-info"></i>Sesión Virtual</strong>
                                                                    {% if cita.enlace_llamada %}
                                                                    <div class="mt-2">
                                                                        <strong>Enlace de Google Meet:</strong><br>
                                                                        <div class="input-group mt-1">
                                                                            <input type="text" class="form-control" value="{{ cita.enlace_llamada }}" readonly>
                                                                            <button class="btn btn-outline-secondary" type="button" 
                                                                                    onclick="navigator.clipboard.writeText('{{ cita.enlace_llamada }}')">
                                                                                <i class="fas fa-copy"></i>
                                                                            </button>
                                                                        </div>
                                                                        {% if cita.puede_unirse %}
                                                                        <div class="mt-2">
                                                                            <a href="{{ cita.enlace_llamada }}" target="_blank" class="btn btn-success">
                                                                                <i class="fas fa-video me-1"></i>Unirse a la Sesión Virtual
                                                                            </a>
                                                                        </div>
                                                                        {% else %}
                                                                        <small class="text-muted">
                                                                            El enlace estará disponible 15 minutos antes de la sesión
                                                                        </small>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% else %}
                                                                    <p class="text-muted mb-0">Enlace de sesión no generado aún.</p>
                                                                    {% endif %}
                                                                </div>
                                                                {% else %}
                                                                <div class="mb-3">
                                                                    <strong><i class="fas fa-building me-2 text-success"></i>Sesión Presencial</strong>
                                                                    <div class="mt-2">
                                                                        <strong>Ubicación:</strong><br>
                                                                        {{ cita.ubicacion_presencial|default:"Sede Principal SoulComfort - San Miguel" }}
                                                                    </div>
                                                                    <div class="alert alert-warning mt-2">
                                                                        <small>
                                                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                                                            Por favor presenta puntualidad en la sede asignada.
                                                                        </small>
                                                                    </div>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>

                                                        {% if cita.notas %}
                                                        <hr>
                                                        <div class="mb-3">
                                                            <strong>Notas adicionales:</strong><br>
                                                            <div class="border rounded p-3 bg-light">
                                                                {{ cita.notas|linebreaks }}
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                                        {% if cita.modalidad == 'virtual' and cita.enlace_llamada and cita.puede_unirse %}
                                                        <a href="{{ cita.enlace_llamada }}" target="_blank" class="btn btn-success">
                                                            <i class="fas fa-video me-1"></i>Unirse a Sesión
                                                        </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No tienes citas programadas</h5>
                        <p class="text-muted">
                            {% if user.userprofile.es_pasante %}
                            Agenda citas con pacientes desde la sección "Agendar Citas"
                            {% else %}
                            Registra tu disponibilidad para que los pasantes puedan agendar sesiones contigo
                            {% endif %}
                        </p>
                        {% if user.userprofile.es_pasante %}
                        <a href="{% url 'miapp:agendar_cita' %}" class="btn btn-primary">
                            <i class="fas fa-calendar-plus me-2"></i>Agendar Citas
                        </a>
                        {% else %}
                        <a href="{% url 'miapp:gestionar_disponibilidad_paciente' %}" class="btn btn-primary">
                            <i class="fas fa-clock me-2"></i>Gestionar Disponibilidad
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Información importante -->
            <div class="alert alert-info mt-4">
                <h5><i class="fas fa-info-circle me-2"></i>Información Importante</h5>
                <ul class="mb-0">
                    <li><strong>Sesiones Virtuales:</strong> El enlace estará disponible 15 minutos antes de la hora programada</li>
                    <li><strong>Sesiones Presenciales:</strong> Dirígete a la ubicación indicada con 10 minutos de anticipación</li>
                    <li>Las sesiones tienen una duración de <strong>1 hora</strong></li>
                    <li>Para sesiones virtuales: asegúrate de tener conexión estable y auriculares</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
    .btn-group-vertical .btn {
        text-align: left;
    }
</style>
{% endblock %}